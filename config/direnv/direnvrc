# direnv functions for automatically setting up the virtual environment
# for Python projects.

# Usage:
# 1. Create a .envrc file in your project's root
# 2. Add the following line to .envrc:
#      layout_poetry
# or:
#      layout_venv
# 3. Authorize direnv to load it:
#      direnv allow

# direnv configuration for poetry projects
# The function will:
# - Automatically activate the .venv virtual environment when you cd into the directory
# - Create .venv via 'poetry install' if it doesn't exist
# - Deactivate when you cd out of the directory
layout_poetry() {
  if [[ ! -f "pyproject.toml" ]]; then
    log_error "layout poetry requires pyproject.toml"
    return 1
  fi

  if [[ ! -d ".venv" ]]; then
    if ! command -v poetry &>/dev/null; then
      log_error "poetry is not installed"
      return 1
    fi
    log_status "creating .venv via poetry install"
    if ! poetry install; then
      log_error "poetry install failed"
      return 1
    fi
  fi

  VIRTUAL_ENV="$(pwd)/.venv"
  export VIRTUAL_ENV
  PATH_add "$VIRTUAL_ENV/bin"
}

# direnv configuration for generic .venv directories
layout_venv() {
  VIRTUAL_ENV="$(pwd)/.venv"
  if [[ ! -d "$VIRTUAL_ENV" ]]; then
    log_error "Virtual environment $VIRTUAL_ENV does not exist"
    return 1
  fi

  export VIRTUAL_ENV
  PATH_add "$VIRTUAL_ENV/bin"
}
