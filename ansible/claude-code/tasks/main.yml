---
- name: Check if claude is already installed
  command: command -v claude
  register: claude_exists
  ignore_errors: true
  changed_when: false

- name: Install Claude Code
  shell: curl -fsSL https://claude.ai/install.sh | bash -s latest
  when: claude_exists.rc != 0

- name: Ensure ~/.claude directory exists
  file:
    path: "{{ home_dir }}/.claude"
    state: directory

- name: Get status for ~/.claude/settings.json
  stat:
    path: "{{ home_dir }}/.claude/settings.json"
  register: claude_settings

- name: Preserve existing ~/.claude/settings.json
  command: mv "{{ home_dir }}/.claude/settings.json" "{{ home_dir }}/.claude/settings.json.backup"
  when: claude_settings.stat.isreg is defined and claude_settings.stat.isreg and not claude_settings.stat.islnk

- name: Create link for ~/.claude/settings.json
  file:
    src: "{{ home_dir }}/dotfiles/config/claude/settings.json"
    dest: "{{ home_dir }}/.claude/settings.json"
    state: link
